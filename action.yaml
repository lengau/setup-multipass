name: Setup Multipass
description: Set up Multipass on a GitHub runner
inputs:
  wait:
    description: Wait for Multipass to complete install and startup
    default: true

runs:
  using: "composite"
  steps:
    - if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        sudo snap install multipass
        sudo multipass set local.passphrase="${GITHUB_TOKEN}"
        multipass authenticate "${GITHUB_TOKEN}"
    - if: ${{ runner.os == 'macOS' }}
      shell: bash
      run: |
        curl -o ${{ runner.temp }}/multipass.pkg -L https://canonical.com/multipass/download/macos
        sudo installer -pkg ${{ runner.temp }}/multipass.pkg -target /
        sudo multipass set local.passphrase="${GITHUB_TOKEN}"
        multipass authenticate "${GITHUB_TOKEN}"
    - if: ${{ inputs.wait == 'true' }}
      shell: bash
      run: |
        echo Waiting until Multipass is up...
        while ! multipass list; do
          sleep 1
        done
